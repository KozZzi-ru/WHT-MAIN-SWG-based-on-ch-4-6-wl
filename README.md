# КОНФИГУРАЦИЯ ZMK ДЛЯ CHARYBDIS 4X6 WIRELESS MK1 (WHITE)

Стабильная прошивка ZMK для беспроводной сплит-клавиатуры **Charybdis 4x6 MK1 WHITE** с трекболом **PMW3610** и автогенерацией SVG-схемы раскладки.

## Содержание

- [Особенности прошивки](#особенности-прошивки)
- [Ветки репозитория](#ветки-репозитория)
- [Аппаратная конфигурация](#аппаратная-конфигурация)
- [Структура репозитория](#структура-репозитория)
- [Режимы работы трекбола](#режимы-работы-трекбола)
- [West.yml конфигурация](#westyml-конфигурация)
- [GitHub Actions конфигурация](#github-actions-конфигурация)
- [Визуализация раскладки](#визуализация-раскладки)
- [Слои клавиатуры](#слои-клавиатуры)
- [Макросы](#макросы)
- [Сборка прошивки](#сборка-прошивки)
- [Прошивка устройств](#прошивка-устройств)
- [История изменений](#история-изменений)

## Особенности прошивки

### ZMK и драйверы
- **ZMK**: стабильная ветка **v0.3-branch**
- **Драйвер трекбола**: от inorichi ([zmk-pmw3610-driver](https://github.com/inorichi/zmk-pmw3610-driver))
- **Контроллер**: nice_nano_v2 (ProMicro nRF52840)

### Ключевые возможности
- **Автоматическая генерация визуализации раскладки** в формате SVG при каждой сборке
- **SVG включается в артефакт** вместе с файлами прошивки
- **Макросы на русском языке** для быстрого ввода фраз
- **Плавный скролл** и расширенное управление мышью
- **Оптимизированные слои** для реальной работы (6 слоев вместо 10)
- **Оптимизированный Bluetooth** буфер для стабильной связи

## Ветки репозитория

### main (текущая)
**Назначение**: Основная стабильная ветка для повседневного использования

**Технические особенности**:
- **ZMK**: v0.3-branch (стабильная, проверенная версия)
- **Драйвер**: inorichi/zmk-pmw3610-driver (main)
- **Контроллер**: nice_nano_v2
- **Zephyr**: совместима с v0.3

**Режимы трекбола**:
- Конфигурация через параметры `scroll-layers` и `snipe-layers`
- Scroll на слое 0 (QWERTY)
- Snipe на слое 4 (точный режим)
- Без input processors (простая конфигурация)

**Рекомендации**: Используй эту ветку для повседневной работы. Проверенная стабильность, простая настройка.

---

### READY_true-dual-scroll-1600cpi_zmk4_Badjeff
**Назначение**: Экспериментальная ветка с новейшими возможностями ZMK

**Технические особенности**:
- **ZMK**: main (rolling release, Zephyr 4.1)
- **Драйвер**: badjeff/zmk-pmw3610-driver (zmk-0.4)
- **Контроллер**: nice_nano (изменение из-за Zephyr 4.1)
- **CPI**: 1600 (высокая чувствительность)

**Режимы трекбола**:
- **Input processors** - продвинутая обработка ввода
- **Два независимых режима скролла**:
  - Быстрый (слой 0): масштаб 1:60
  - Медленный (слой 1): масштаб 1:240
- **Snipe mode** (слой 3): масштаб 1:5 (замедление в 5 раз)
- **Auto mouse** (слой 2): масштаб 2:3 (ускорение 1.5x)

**Преимущества**:
- Гибкая настройка скорости курсора и скролла
- Два режима скролла для разных задач
- Точное управление через input processors

**Недостатки**:
- Main ветка ZMK может содержать нестабильные изменения
- Сложнее в настройке
- Требует понимания input processors

**Рекомендации**: Для тестирования новых возможностей и экспериментов. Если нужна точная настройка скоростей трекбола.

---

### badjeff-driver
**Назначение**: Тестирование драйвера badjeff на стабильной версии ZMK

**Отличия от main**:
- Драйвер badjeff вместо inorichi
- Те же ZMK v0.3-branch
- Для сравнения производительности драйверов

**Рекомендации**: Только для тестирования. Если драйвер inorichi не подходит.

---

### zmk-main-update
**Назначение**: Рабочая ветка для обновления и тестирования новых версий ZMK

**Отличия**:
- Используется для подготовки миграций
- Может быть нестабильной
- Для разработки, не для использования

**Рекомендации**: Не использовать для повседневной работы.

## Аппаратная конфигурация

### Компоненты
- **Плата контроллера**: nice_nano_v2 (ProMicro nRF52840)
- **Раскладка**: Charybdis 4x6 MK1 WHITE (сплит-клавиатура)
- **Трекбол**: PMW3610 (драйвер от inorichi)
- **Интерфейс трекбола**: SPI

### Пины подключения

#### Клавишная матрица (обе половины)

**Занятые пины:**

Строки (rows, общие):
- **P0.31** - Row 0
- **P1.15** - Row 1
- **P0.24** - Row 2
- **P0.22** - Row 3
- **P1.6** - Row 4

Колонки (columns, каждая половина):
- **P0.2** - Col 0
- **P0.29** - Col 1
- **P0.9** - Col 2
- **P1.0** - Col 3
- **P0.11** - Col 4
- **P1.4** - Col 5

#### Трекбол PMW3610 (только правая половина)

**Занятые пины:**
- **P0.8** - SPI SCK
- **P0.17** - SPI MOSI/MISO
- **P0.20** - SPI CS
- **P0.6** - IRQ

**Итого занято на правой половине:** 15 пинов (5 rows + 6 cols + 4 trackball)

**Итого занято на левой половине:** 11 пинов (5 rows + 6 cols)

#### Свободные пины

**На правой половине:**
- P0.10, P0.30, P1.13, P1.11, P0.3, P0.28

**На левой половине:**
- P0.6, P0.8, P0.17, P0.20, P0.10, P0.30, P1.13, P1.11, P0.3, P0.28

## Структура репозитория

```text
WHT-MAIN-SWG-based-on-ch-4-6-wl/
├── .github/workflows/
│   ├── main.yml                              # Основной workflow сборки
│   └── draw_keymaps.yaml                     # Генерация SVG визуализации
├── config/
│   ├── boards/shields/charybdis/
│   │   ├── charybdis_left.overlay            # Конфигурация левой половины
│   │   ├── charybdis_right.overlay           # Конфигурация правой половины с трекболом
│   │   └── ...
│   ├── charybdis.keymap                      # Раскладка клавиатуры
│   ├── charybdis.conf                        # Глобальная конфигурация ZMK
│   ├── charybdis.json                        # Физическое описание раскладки
│   └── west.yml                              # Манифест зависимостей
├── keymap-drawer/
│   ├── config.yaml                           # Настройки визуализации
│   ├── charybdis.svg                         # Автоматически сгенерированная визуализация
│   └── charybdis.yaml                        # YAML представление раскладки
└── README.md                                 # Этот файл
```

### Ключевые файлы

- **`charybdis_right.overlay`**: Аппаратная конфигурация правой половины (GPIO, SPI, трекбол)
- **`config/west.yml`**: Зависимости прошивки (ZMK v0.3, драйвер inorichi)
- **`charybdis.keymap`**: Раскладка клавиш, макросы, слои
- **`charybdis.json`**: Физическое описание клавиатуры для keymap-drawer

## Режимы работы трекбола

В ZMK v0.3 с драйвером inorichi используется конфигурация через параметры `scroll-layers` и `snipe-layers` в overlay-файле.

### Режимы

**1. Режим скролла (слой 0 - QWERTY)**
- **Параметр**: `scroll-layers = <0>`
- **Назначение**: Прокрутка документов трекболом на базовом слое
- **Применение**: Просмотр длинных страниц, документов

**2. Режим мыши (слои 1, 2, 3, 5)**
- **Поведение**: Стандартное перемещение курсора
- **Назначение**: Обычная навигация курсором
- **Применение**: Клики, перемещение, работа с интерфейсом

**3. Снайперский режим (слой 4 - snipe_layer)**
- **Параметр**: `snipe-layers = <4>`
- **Назначение**: Точные операции, замедленное движение курсора
- **Применение**: Работа с мелкими элементами интерфейса

### Настройка CPI

Драйвер inorichi использует дефолтное значение CPI сенсора PMW3610.

**Для изменения CPI** добавь параметр в `charybdis_right.overlay`:

```dts
trackball: trackball@0 {
    compatible = "pixart,pmw3610";
    cpi = <800>;  // Укажи нужное значение
    scroll-layers = <0>;
    snipe-layers = <4>;
};
```

**Рекомендуемые значения:**
- `400` - Низкая чувствительность
- `800` - Средняя чувствительность (рекомендуется)
- `1200` - Высокая чувствительность
- `1600` - Очень высокая чувствительность

## West.yml конфигурация

Файл `config/west.yml` определяет зависимости прошивки ZMK и внешние модули.

### Удалённые репозитории

```yaml
remotes:
  - name: zmkfirmware
    url-base: https://github.com/zmkfirmware
  - name: inorichi
    url-base: https://github.com/inorichi
```

- **zmkfirmware**: Основная прошивка ZMK
- **inorichi**: Драйвер трекбола PMW3610

### Зависимости

- **zmk**: Стабильная прошивка ZMK (ветка `v0.3-branch`)
- **zmk-pmw3610-driver**: Драйвер трекбола PMW3610
  - Источник: [inorichi/zmk-pmw3610-driver](https://github.com/inorichi/zmk-pmw3610-driver)
  - Проверенная стабильная версия для ZMK v0.3

## GitHub Actions конфигурация

Файл `.github/workflows/main.yml` определяет автоматическую сборку прошивки при каждом push.

### Процесс сборки

```yaml
jobs:
  keymap_images:
    permissions:
      contents: write
    uses: ./.github/workflows/draw_keymaps.yaml
    with:
      destination: 'both'
      artifact_name: 'keymap_raw_files'
    
  build:
    needs: keymap_images
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@v0.3-branch
    with:
      archive_name: firmware_WHT
      
  package_with_keymap:
    needs: [build, keymap_images]
    runs-on: ubuntu-latest
    # Создание финального артефакта firmware_WHT_SVG
```

### Этапы

1. **keymap_images**: Генерация SVG-визуализации раскладки из `config/charybdis.keymap`
2. **build**: Сборка файлов `.uf2` для обеих половин клавиатуры
3. **package_with_keymap**: Объединение прошивки и визуализации в один артефакт

### Результат

Артефакт `firmware_WHT_SVG` содержит:
- `charybdis_left-nice_nano_v2-zmk.uf2`
- `charybdis_right-nice_nano_v2-zmk.uf2`
- `settings_reset-nice_nano_v2-zmk.uf2`
- `charybdis.svg` - визуализация раскладки

## Визуализация раскладки

Визуализация автоматически генерируется из файла `config/charybdis.keymap` с помощью [Keymap Drawer](https://github.com/caksoylar/keymap-drawer) при каждой сборке.

![Charybdis Keymap](keymap-drawer/charybdis.svg)

Визуализация также доступна в репозитории: [keymap-drawer/charybdis.svg](keymap-drawer/charybdis.svg)

### Настройка визуализации

Для изменения внешнего вида редактируй `keymap-drawer/config.yaml`:
- Размеры и форма клавиш
- Отступ между половинами
- Цвета и тема
- Шрифты и размер текста
- Маппинг клавиш в короткие подписи

## Слои клавиатуры

Прошивка использует **6 оптимизированных слоев** (неиспользуемые слои удалены):

### Слой 0: QWERTY
- **Назначение**: Базовый слой для обычной работы
- **Трекбол**: Режим скролла
- **Особенности**: Стандартная QWERTY-раскладка

### Слой 1: num_and_fun
- **Назначение**: Цифры, numpad, F-клавиши, навигация
- **Трекбол**: Режим мыши (курсор)
- **Клавиши**: Цифровой блок, F1-F12, стрелки

### Слой 2: auto_mouse
- **Назначение**: Клики мыши и скролл
- **Трекбол**: Режим мыши (курсор)
- **Клавиши**:
  - `&mkp LCLK` - Левый клик
  - `&mkp RCLK` - Правый клик
  - `&mkp MCLK` - Средний клик
  - `&msc SCRL_LEFT` - Скролл влево
  - `&msc SCRL_RIGHT` - Скролл вправо

### Слой 3: snipe_layer
- **Назначение**: Точный режим мыши (снайперский)
- **Трекбол**: Замедленный курсор для точности
- **Применение**: Работа с мелкими элементами

### Слой 4: corrections
- **Назначение**: Коррекции текста и макросы
- **Трекбол**: Режим мыши (курсор)
- **Клавиши**:
  - `&phrase_proshu` - Печатает "ПРОШУ ПРОЩЕНИЯ" + Enter
  - `&phrase_spasibo` - Печатает "СПАСИБО!" + Enter
  - `LC(Z)` - Отмена (Undo)
  - `LC(BACKSPACE)` - Удалить слово назад
  - `LC(DELETE)` - Удалить слово вперед

### Слой 5: set_bt
- **Назначение**: Настройка Bluetooth и вход в bootloader
- **Трекбол**: Режим мыши (курсор)
- **Клавиши**:
  - `&bt BT_SEL 0-4` - Выбор профиля Bluetooth
  - `&bt BT_CLR` - Очистка текущего профиля
  - `&bootloader` - Вход в режим прошивки

## Макросы

В прошивке настроены макросы на русском языке:

### phrase_proshu
```c
phrase_proshu: phrase_proshu {
    compatible = "zmk,behavior-macro";
    #binding-cells = <0>;
    bindings = <&kp LS(P) &kp R &kp O &kp W &kp U 
                &kp SPACE &kp LS(P) &kp R &kp O &kp W &kp E &kp N &kp I &kp Q 
                &kp ENTER>;
};
```
**Выход**: ПРОШУ ПРОЩЕНИЯ + Enter

### phrase_spasibo
```c
phrase_spasibo: phrase_spasibo {
    compatible = "zmk,behavior-macro";
    #binding-cells = <0>;
    bindings = <&kp LS(S) &kp P &kp A &kp S &kp I &kp B &kp O 
                &kp LS(N1) &kp ENTER>;
};
```
**Выход**: СПАСИБО! + Enter

## Сборка прошивки

### GitHub Actions (автоматически)

При каждом push в репозиторий автоматически запускается процесс сборки:

1. **Генерация визуализации раскладки**: Workflow `draw_keymaps.yaml` автоматически создаёт SVG-изображение твоей раскладки клавиатуры из файла `config/charybdis.keymap`

2. **Сборка прошивки**: Компилируются файлы `.uf2` для обеих половин клавиатуры

3. **Создание пакета**: Формируется финальный артефакт `firmware_WHT_SVG`, содержащий:
   - `charybdis_left-nice_nano_v2-zmk.uf2` - прошивка левой половины
   - `charybdis_right-nice_nano_v2-zmk.uf2` - прошивка правой половины
   - `settings_reset-nice_nano_v2-zmk.uf2` - сброс настроек
   - `charybdis.svg` - визуализация раскладки клавиатуры

4. **Скачивание**: Открой вкладку Actions в репозитории → выбери последний успешный build → скачай артефакт `firmware_WHT_SVG`

Визуализация раскладки также автоматически коммитится в папку `keymap-drawer/` в репозитории.

## Прошивка устройств

### Процесс прошивки

1. Дважды нажми кнопку reset на плате (быстро, два раза подряд)
2. Плата появится как USB-накопитель с именем `NICENANO`
3. Скопируй соответствующий `.uf2` файл на этот накопитель
4. Плата автоматически перезагрузится с новой прошивкой

### Когда прошивать какие файлы

| Что изменил | Левая | Правая | Reset |
|-------------|-------|--------|-------|
| Настройки трекбола (режимы, CPI) | ❌ | ✅ | ❌ |
| Раскладка клавиш (keymap) | ✅ | ✅ | ❌ |
| Комбинации клавиш (combos) | ✅ | ✅ | ❌ |
| Макросы | ✅ | ✅ | ❌ |
| Обновление ZMK/драйвера | ✅ | ✅ | ✅ |
| Проблемы с Bluetooth | ✅ | ✅ | ✅ |
| Первая прошивка | ✅ | ✅ | ✅ |
| Пины/аппаратная конфигурация трекбола | ❌ | ✅ | ❌ |
| Глобальные настройки (charybdis.conf) | ✅ | ✅ | ❌ |

## История изменений

### 01.02.2026 - Обновлен README
- Создан подробный README по структуре экспериментальных веток
- Добавлено описание всех слоев и их назначения
- Добавлено описание режимов работы трекбола для ZMK v0.3
- Добавлена информация о макросах на русском языке
- Добавлена детальная информация о занятых и свободных пинах
- Добавлена визуализация раскладки и ссылка на SVG
- Раздел "Ветки репозитория" перемещен вверх с расширенными описаниями

### Предыдущие изменения
- Интеграция keymap-drawer для автогенерации SVG-схем
- Создание workflow для упаковки SVG вместе с прошивкой
- Оптимизация слоев: удалены неиспользуемые слои (scroll, symbol, layer_8, layer_9)
- Добавлены макросы на русском: phrase_proshu, phrase_spasibo
- Настройка кастомного поведения mmv_slow для точного управления курсором
- Конфигурация трекбола: scroll-layers, snipe-layers
- Увеличение BT буфера: `CONFIG_BT_BUF_EVT_RX_COUNT=40`

## Полезные ссылки

- [ZMK Firmware](https://github.com/zmkfirmware/zmk) - основная прошивка ZMK
- [PMW3610 Driver by inorichi](https://github.com/inorichi/zmk-pmw3610-driver) - драйвер трекбола PMW3610
- [Keymap Drawer](https://github.com/caksoylar/keymap-drawer) - генератор визуализации раскладок
- [ZMK Documentation](https://zmk.dev) - официальная документация ZMK

## Примечание

⚠️ **Стабильная ветка!** Эта ветка использует проверенную версию ZMK v0.3-branch для максимальной стабильности. Для экспериментов с новыми возможностями ZMK используй ветку `READY_true-dual-scroll-1600cpi_zmk4_Badjeff`.
